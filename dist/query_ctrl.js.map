{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","_","angular","StatseekerQueryCtrl","$scope","$injector","uiSegmentSrv","scope","outputModes","text","value","sortDirections","fieldSelection","filterSelection","sortSelection","objectList","fieldMap","deviceFieldMap","selectedObject","target","object","loadObjectList","then","loadFieldMap","obj","forOwn","f_dev","val","key","datasource","templateSrv","replace","f","startsWith","merge","o","object_opts","fields","filters","adv_filter","sortby","limit","offset","output","length","Promise","resolve","runRequest","url","i","rows","response","data","objects","push","name","_index","res","err","message","config","success","status","errmsg","formats","get","v","fmt","sortBy","toLowerCase","transformToSegments","field","fld","formatFirstTemplate","cloneDeep","alias","f_alias","getFormatList","fieldHasFormats","row","format","hide","order","index","removeFilter","removeSort","splice","map","join","tmp","rawMode","attempt","JSON","parse","rawQuery","isError","toJson","variable","fn","isArray","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport _ from 'lodash';\nimport angular from 'angular';\n\nexport class StatseekerQueryCtrl extends QueryCtrl {\n\n   constructor($scope, $injector, uiSegmentSrv)  {\n      super($scope, $injector);\n\n      this.scope = $scope;\n      this.uiSegmentSrv = uiSegmentSrv;\n      this.outputModes = [\n         {text: 'Timeseries', value: 'timeseries'},\n         {text: 'Table', value: 'table'}\n      ];\n      this.sortDirections = [\n         {text: 'Ascending', value: 'asc'},\n         {text: 'Descending', value: 'desc'}\n      ];\n\n      this.fieldSelection = '+';\n      this.filterSelection = '+';\n      this.sortSelection = '+';\n      this.objectList = [];\n      this.fieldMap = {};\n      this.deviceFieldMap = {};\n      this.selectedObject = this.target.object;\n      this.loadObjectList().then(o => {\n         this.loadFieldMap('cdt_device').then(f_dev => {\n            var obj;\n\n            /* Prepend 'Device' to all fields */\n            _.forOwn(f_dev, (val, key) => {\n               this.deviceFieldMap['cdt_device.' + key] = val;\n            });\n            if (this.selectedObject) {\n               obj = this.datasource.templateSrv.replace(this.selectedObject);\n\n               this.loadFieldMap(obj).then(f => {\n                  this.fieldMap = f;\n                  if (obj !== 'cdt_device' && obj !== 'cdt_ranges' && obj.startsWith('cdt_')) {\n                     _.merge(this.fieldMap, this.deviceFieldMap);\n                  }\n                  this.objectList = o;\n               });\n            }\n         });\n      });\n\n      /* Target properties */\n      this.target.object      = this.target.object      || 'Select object';\n      this.target.object_opts = this.target.object_opts || null;\n      this.target.fields      = this.target.fields      || [];\n      this.target.filters     = this.target.filters     || [];\n      this.target.adv_filter  = this.target.adv_filter  || null;\n      this.target.sortby      = this.target.sortby      || [];\n      this.target.limit       = this.target.limit       || 10;\n      this.target.offset      = this.target.offset      || 0;\n      this.target.output      = this.target.output      || 'timeseries';\n   }\n\n   loadObjectList() {\n      if (this.objectList.length > 0) {\n         return Promise.resolve(this.objectList);\n      }\n\n      return this.datasource.runRequest(this.datasource.url + '/object/?fields=name&limit=0&links=none', 'GET').then(response => {\n         var i;\n         var output = [];\n         var rows = response.data.data.objects[0].data;\n\n         if (rows.length === 0) {\n            return output;\n         }\n\n         for (i = 0; i < rows.length; i++) {\n            output.push({text: rows[i].name, value: rows[i].name});\n         }\n\n         /* Add the template variables */\n         _.forOwn(this.datasource.templateSrv._index, (val, key) => {\n            output.push({text: '$' + key, value: '$' + key});\n         });\n\n         return output;\n      },\n      err => {\n         var res;\n\n         if ( ! err.data.data) {\n            throw {message: 'Request failed', data: err.data, config: err.config};\n         }\n         res = err.data.data;\n         if ( ! res.success) {\n            if (res.objects.length === 1) {\n               throw {message: res.objects[0].status.errmsg, data: err.data, config: err.config};\n            }\n            else {\n               throw {message: res.errmsg, data: err.data, config: err.config};\n            }\n         }\n      });\n   }\n\n   loadFieldMap(obj) {\n      if ( ! obj || obj === 'Select object') {\n         return Promise.resolve([]);\n      }\n\n      return this.datasource.runRequest(this.datasource.url + '/' + obj + '/describe?links=none', 'GET').then(response => {\n         var fieldMap, formats;\n\n         fieldMap = response.data.data.objects[0].fields;\n         _.forOwn(fieldMap, (val, key) => {\n            formats = [];\n            _.forOwn(_.get(val, 'options.formats.values', []), (v, fmt) => {\n               formats.push({text: fmt, value: fmt});\n            });\n            val.formats = _.sortBy(formats, [v => {\n               v.text.toLowerCase();\n            }]);\n         });\n\n         /* Add the template variables */\n         _.forOwn(this.datasource.templateSrv._index, (val, key) => {\n            fieldMap['$' + key] = {name: '$' + key};\n            fieldMap['$' + key].formats = [];\n         });\n\n         return fieldMap;\n      },\n      err => {\n         var res;\n\n         if ( ! err.data.data) {\n            throw {message: 'Request failed', data: err.data, config: err.config};\n         }\n         res = err.data.data;\n         if ( ! res.success) {\n            if (res.objects.length === 1) {\n               throw {message: res.objects[0].status.errmsg, data: err.data, config: err.config};\n            }\n            else {\n               throw {message: res.errmsg, data: err.data, config: err.config};\n            }\n         }\n      });\n   }\n\n   getFieldList() {\n      var output = [];\n\n      _.forOwn(this.fieldMap, (val, key) => {\n         output.push({text: key, value: key});\n      });\n\n      return Promise.resolve(_.sortBy(output, [val => {\n         val.text.toLowerCase();\n      }])).then(this.uiSegmentSrv.transformToSegments(false));\n   }\n\n   getFormatList(field) {\n      var output = [];\n      var fld = this.datasource.templateSrv.replace(field, null, this.formatFirstTemplate);\n\n      if (this.fieldMap[fld]) {\n         output = _.cloneDeep(this.fieldMap[fld].formats);\n         /* Add the template variables */\n         _.forOwn(this.datasource.templateSrv._index, (val, key) => {\n            output.push({text: '$' + key, value: '$' + key});\n         });\n      }\n\n      return Promise.resolve(_.sortBy(output, [val => {\n         val.text.toLowerCase();\n      }])).then(this.uiSegmentSrv.transformToSegments(false));\n   }\n\n   fieldHasFormats(field) {\n      var fld = this.datasource.templateSrv.replace(field, null, this.formatFirstTemplate);\n\n      return this.fieldMap[fld] && this.fieldMap[fld].formats.length > 0;\n   }\n\n   getSelectedFields() {\n      var i, alias;\n      var output = [];\n\n      for (i = 0; i < this.target.fields.length; i++) {\n         alias = this.target.fields[i].alias ? this.target.fields[i].alias : this.target.fields[i].name;\n         output.push({text: alias, value: alias});\n      }\n\n      return Promise.resolve(_.sortBy(output, [val => {\n         val.text.toLowerCase();\n      }])).then(this.uiSegmentSrv.transformToSegments(false));\n   }\n\n   getAliasFormats(alias) {\n      var i, f_alias;\n\n      for (i = 0; i < this.target.fields.length; i++) {\n         f_alias = this.target.fields[i].alias ? this.target.fields[i].alias : this.target.fields[i].name;\n         if (f_alias === alias && this.fieldMap[this.target.fields[i].name]) {\n            return this.getFormatList(this.target.fields[i].name);\n         }\n      }\n\n      return [];\n   }\n\n   aliasHasFormats(alias) {\n      var i, f_alias;\n\n      for (i = 0; i < this.target.fields.length; i++) {\n         f_alias = this.target.fields[i].alias ? this.target.fields[i].alias : this.target.fields[i].name;\n         if (f_alias === alias && this.fieldMap[this.target.fields[i].name]) {\n            return this.fieldHasFormats(this.target.fields[i].name);\n         }\n      }\n\n      return false;\n   }\n\n   objectChanged() {\n      var obj = this.datasource.templateSrv.replace(this.target.object);\n\n      this.target.fields = [];\n      this.target.filters = [];\n      this.target.sortby = [];\n      this.target.object_opts = null;\n      this.selectedObject = null;\n\n      this.loadFieldMap(obj).then(f => {\n         this.fieldMap = f;\n         if (obj !== 'cdt_device' && obj !== 'cdt_ranges' && obj.startsWith('cdt_')) {\n            _.merge(this.fieldMap, this.deviceFieldMap);\n         }\n         this.selectedObject = this.target.object;\n      });\n   }\n\n   addField() {\n      var row = {name: this.fieldSelection, format: 'Select format', hide: false};\n\n      this.target.fields.push(row);\n      this.fieldSelection = '+';\n   }\n\n   addFilter() {\n      var row = {field: this.filterSelection, format: 'Select format'};\n\n      this.target.filters.push(row);\n      this.filterSelection = '+';\n   }\n\n   addSort() {\n      var row = {field: this.sortSelection, format: 'Select format', order: 'asc'};\n\n      this.target.sortby.push(row);\n      this.sortSelection = '+';\n   }\n\n   removeField(index) {\n      var i;\n      var alias = this.target.fields[index].alias ? this.target.fields[index].alias : this.target.fields[index].name;\n\n      /* Remove any dependent filters and sorting */\n      for (i = 0; i < this.target.filters.length; i++) {\n         if (this.target.filters[i].field === alias) {\n            this.removeFilter(i);\n         }\n      }\n      for (i = 0; i < this.target.sortby.length; i++) {\n         if (this.target.sortby[i].field === alias) {\n            this.removeSort(i);\n         }\n      }\n      this.target.fields.splice(index, 1);\n   }\n\n   removeFilter(index) {\n      this.target.filters.splice(index, 1);\n   }\n\n   removeSort(index) {\n      this.target.sortby.splice(index, 1);\n   }\n\n   getCollapsedText() {\n      return this.target.object + ' (' + _.map(this.target.fields, 'field').join(', ') + ') as ' + this.target.output;\n   }\n\n   toggleEditorMode() {\n      var tmp;\n\n      if (this.target.rawMode) {\n         /* Recreate the target */\n         tmp = _.attempt(JSON.parse, this.target.rawQuery);\n         if (_.isError(tmp)) {\n            throw {message: 'JSON decode failed'};\n         }\n         this.target = tmp;\n         this.target.rawMode = false;\n      }\n      else {\n         /* Encode the raw query */\n         if (typeof this.target.rawQuery !== 'undefined') {\n            delete this.target.rawQuery;\n         }\n         if (typeof this.target.rawMode !== 'undefined') {\n            delete this.target.rawMode;\n         }\n         this.target.rawQuery = angular.toJson(this.target);\n         this.target.rawMode = true;\n      }\n   }\n\n   formatFirstTemplate(value, variable, fn) {\n      if (_.isArray(value)) {\n         return value[0];\n      }\n\n      return value;\n   }\n\n\n}\n\nStatseekerQueryCtrl.templateUrl = 'partials/query.editor.html';\n\n"]}